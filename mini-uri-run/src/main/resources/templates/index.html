<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <!-- SEO优化：添加描述和关键词 -->
    <title>Mini URI - 免费高效的短链接生成器</title>
    <meta name="description" content="Mini URI 提供免费、快速、稳定的短链接生成服务，支持自定义有效期，是您简化分享、提升品牌形象的理想选择。">
    <meta name="keywords" content="短链接,短网址,短链接生成,网址缩短,URL缩短,Mini URI">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <!-- 仅保留自定义脚本，使用原生实现 -->
    <script defer th:src="@{/static/js/request.js}"></script>
    <script defer th:src="@{/static/js/api.js}"></script>
    <link rel="icon" th:href="@{/static/img/favicon.ico}">
    <link rel="stylesheet" th:href="@{/static/css/base.css}">
</head>
<body>
<div class="box">
    <!-- SEO优化：添加H1标签 -->
    <h1 style="text-align: center; margin-bottom: 20px;">短链接生成器</h1>
    <div>
        <div class="inp" id="long-wrapper">
            <input type="text" id="long" placeholder="&nbsp;" aria-label="长链接输入框">
            <label for="long" class="label">长链接</label>
            <span class="focus-bg"></span>
            <button id="clear-long" type="button" class="clear-x" aria-label="清除输入" tabindex="-1">×</button>
        </div>
    </div>
    <div class="options">
        <!-- SEO优化：添加H2标签 -->
        <h2 class="options-title">有效时间</h2>
        <div class="options-group">
            <label for="exp-1"><input type="radio" id="exp-1" name="expirationTime" value="1" checked><span>1天</span></label>
            <label for="exp-7"><input type="radio" id="exp-7" name="expirationTime" value="7"><span>7天</span></label>
            <label for="exp-30"><input type="radio" id="exp-30" name="expirationTime" value="30"><span>1个月</span></label>
            <label for="exp-90"><input type="radio" id="exp-90" name="expirationTime" value="90"><span>3个月</span></label>
        </div>
    </div>
    <button type="button" id="generate">生成短链接</button>
    <div style="text-align: center;">
        <label for="short" class="inp short">
            <input type="text" id="short" placeholder="&nbsp;" aria-label="短链接输出框" readonly>
            <span class="label">短链接</span>
            <span class="focus-bg"></span>
        </label>
        <button type="button" id="copy" class="btn-copy">Copy</button>
    </div>
</div>
<script>
    window.addEventListener('DOMContentLoaded', function () {
        const btnGenerate = document.getElementById('generate');
        const inputLong = document.getElementById('long');
        const inputShort = document.getElementById('short');
        const btnCopy = document.getElementById('copy');
        const btnClearLong = document.getElementById('clear-long');
        const longWrapper = document.getElementById('long-wrapper');

        // 根据是否有值切换 has-value 类，控制 × 的显隐
        const updateHasValue = () => {
            if (inputLong.value && inputLong.value.trim().length > 0) {
                longWrapper.classList.add('has-value');
            } else {
                longWrapper.classList.remove('has-value');
            }
        };
        inputLong.addEventListener('input', updateHasValue);
        inputLong.addEventListener('change', updateHasValue);
        inputLong.addEventListener('focus', updateHasValue);
        inputLong.addEventListener('blur', updateHasValue);
        updateHasValue();

        // 点击 × 清除输入（封装成函数，供多事件复用）
        function clearLongNow(e) {
            if (e) { e.preventDefault(); e.stopPropagation(); }
            inputLong.value = '';
            inputShort.value = '';
            // 触发 input 事件，确保所有监听者（含样式联动）正确响应
            try { inputLong.dispatchEvent(new Event('input', { bubbles: true })); } catch (_){}
            // 下一帧再更新 has-value，避免在当前点击过程中立刻把按钮变成不可点导致“清不掉”
            setTimeout(updateHasValue, 0);
            inputLong.focus({ preventScroll: true });
        }

        // 防止按下时切换焦点，避免触发父级状态变化
        btnClearLong.addEventListener('mousedown', function (e) { e.preventDefault(); });
        btnClearLong.addEventListener('touchstart', function (e) { clearLongNow(e); }, { passive: false });
        btnClearLong.addEventListener('click', function (e) { clearLongNow(e); });

        // 防抖处理和按钮状态管理
        let isGenerating = false;
        const originalButtonText = btnGenerate.textContent;

        function setButtonLoading(loading) {
            if (loading) {
                btnGenerate.disabled = true;
                btnGenerate.textContent = '生成中...';
                isGenerating = true;
            } else {
                btnGenerate.disabled = false;
                btnGenerate.textContent = originalButtonText;
                isGenerating = false;
            }
        }

        btnGenerate.addEventListener('click', function () {
            // 防止重复点击
            if (isGenerating) {
                return;
            }

            const originalUrl = inputLong.value.trim();
            const checked = document.querySelector('input[name="expirationTime"]:checked');
            const expireTime = checked ? checked.value : '1';
            
            if (!originalUrl) {
                alert('请输入原始链接');
                return;
            }

            // 设置按钮为加载状态
            setButtonLoading(true);

            generateUri({
                originalUrl: originalUrl,
                expireTime: expireTime
            }).then(function (res) {
                if (res && res.code === 200) {
                    inputShort.value = res.data || '';
                } else {
                    alert(res && (res.msg || res.message) || '生成失败');
                }
            }).catch(function (err) {
                alert(err && err.message ? err.message : String(err));
            }).finally(function () {
                // 无论成功还是失败，都要恢复按钮状态
                setButtonLoading(false);
            });
        });

        btnCopy.addEventListener('click', function () {
            const text = inputShort.value || '';
            if (!text) {
                alert('没有可复制的内容');
                return;
            }
            if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
                navigator.clipboard.writeText(text).then(function () {
                    btnCopy.textContent = 'Copied!';
                    setTimeout(function () { btnCopy.textContent = 'Copy'; }, 2000);
                }).catch(function () {
                    fallbackCopy();
                });
            } else {
                fallbackCopy();
            }
        });

        function fallbackCopy() {
            inputShort.select();
            try {
                const ok = document.execCommand('copy');
                if (ok) {
                    btnCopy.textContent = 'Copied!';
                    setTimeout(function () { btnCopy.textContent = 'Copy'; }, 2000);
                } else {
                    alert('复制失败，请手动复制');
                }
            } catch (e) {
                alert('复制失败，请手动复制');
            } finally {
                window.getSelection && window.getSelection().removeAllRanges();
                inputShort.blur();
            }
        }
    });
</script>
</body>
</html>

