<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <!-- SEO优化：添加描述和关键词 -->
    <title th:text="#{page.title}">Mini URI - 免费高效的短链接生成器</title>
    <meta name="description" th:content="#{page.description}" content="Mini URI 提供免费、快速、稳定的短链接生成服务，支持自定义有效期，是您简化分享、提升品牌形象的理想选择。">
    <meta name="keywords" th:content="#{page.keywords}" content="短链接,短网址,短链接生成,网址缩短,URL缩短,Mini URI">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <!-- 仅保留自定义脚本，使用原生实现 -->
<!--    <script-->
<!--        id="counterscale-script"-->
<!--        data-site-id="miniuri"-->
<!--        src="https://counterscale.zhang32912.workers.dev/tracker.js"-->
<!--        defer-->
<!--    ></script>-->
    <script defer th:src="@{/static/js/request.js}"></script>
    <script defer th:src="@{/static/js/api.js}"></script>
    <link rel="icon" th:href="@{/static/img/favicon.ico}">
    <link rel="stylesheet" th:href="@{/static/css/base.css}">
</head>
<body>
<div class="box">
    <!-- SEO优化：添加H1标签 -->
    <h1 style="text-align: center; margin-bottom: 20px;" th:text="#{title.main}">短链接生成器</h1>
    <div>
        <div class="inp" id="long-wrapper">
            <input type="text" id="long" placeholder="&nbsp;" th:aria-label="#{aria.long.input}" aria-label="长链接输入框">
            <label for="long" class="label" th:text="#{label.long.url}">长链接</label>
            <span class="focus-bg"></span>
            <button id="clear-long" type="button" class="clear-x" th:aria-label="#{aria.clear.button}" aria-label="清除输入" tabindex="-1">×</button>
        </div>
    </div>
    <div class="options">
        <!-- SEO优化：添加H2标签 -->
        <h2 class="options-title" th:text="#{options.title}">有效时间</h2>
        <div class="options-group">
            <label for="exp-1"><input type="radio" id="exp-1" name="expirationTime" value="1" checked><span th:text="#{options.1day}">1天</span></label>
            <label for="exp-7"><input type="radio" id="exp-7" name="expirationTime" value="7"><span th:text="#{options.7days}">7天</span></label>
            <label for="exp-30"><input type="radio" id="exp-30" name="expirationTime" value="30"><span th:text="#{options.1month}">1个月</span></label>
            <label for="exp-90"><input type="radio" id="exp-90" name="expirationTime" value="90"><span th:text="#{options.3months}">3个月</span></label>
        </div>
    </div>
    <button type="button" id="generate" th:text="#{button.generate}">生成短链接</button>
    <div style="text-align: center;">
        <label for="short" class="inp short">
            <input type="text" id="short" placeholder="&nbsp;" th:aria-label="#{aria.short.input}" aria-label="短链接输出框" readonly>
            <span class="label" th:text="#{label.short.url}">短链接</span>
            <span class="focus-bg"></span>
        </label>
        <button type="button" id="copy" class="btn-copy" th:text="#{button.copy}">Copy</button>
    </div>
</div>

<!-- 页脚区域 -->
<footer class="footer">
    <div class="footer-content">
        <!-- 赞赏码区域 -->
        <div class="appreciation-section">
            <h3 th:text="#{footer.support.title}">支持我们</h3>
            <p th:text="#{footer.support.desc}">如果这个工具对您有帮助，欢迎请我们喝杯咖啡 ☕</p>
            <div class="qr-container">
                <div class="qr-code" id="qr-code">
                    <!-- 懒加载的赞赏码图片 -->
                    <div class="qr-image-container">
                        <div class="qr-placeholder" id="qr-placeholder">
                            <svg width="120" height="120" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect width="120" height="120" rx="8" fill="#f3f4f6"/>
                                <path d="M60 30C43.4315 30 30 43.4315 30 60C30 76.5685 43.4315 90 60 90C76.5685 90 90 76.5685 90 60C90 43.4315 76.5685 30 60 30ZM60 35C73.8071 35 85 46.1929 85 60C85 73.8071 73.8071 85 60 85C46.1929 85 35 73.8071 35 60C35 46.1929 46.1929 35 60 35Z" fill="#6b7280"/>
                                <circle cx="60" cy="60" r="8" fill="#6b7280"/>
                            </svg>
                            <p class="qr-text" th:text="#{footer.qrcode.placeholder}">赞赏码</p>
                        </div>
                        <div class="qr-loading" id="qr-loading" style="display: none;">
                            <div class="loading-spinner"></div>
                            <p th:text="#{footer.qrcode.loading}">加载中...</p>
                        </div>
                        <img
                            class="qr-image lazy-load"
                            id="qr-image"
                            th:attr="data-src=@{/static/img/zanshang.png}"
                            th:alt="#{footer.qrcode.alt}"
                            alt="赞赏码"
                            style="display: none;"
                        />
                    </div>
                </div>
                <button type="button" class="btn-show-qr" onclick="toggleQRCode()" id="toggle-qr-btn" th:text="#{footer.qrcode.show}">显示赞赏码</button>
            </div>
        </div>

        <!-- 免责声明和版权信息 -->
        <div class="legal-section">
            <div class="disclaimer">
                <h4 th:text="#{footer.disclaimer.title}">免责声明</h4>
                <p th:text="#{footer.disclaimer.content}">本服务仅提供网址缩短功能，不对链接内容负责。用户应确保所缩短的链接内容合法合规，不得用于违法违规用途。使用本服务即表示您同意承担相应责任。</p>
            </div>

            <div class="terms">
                <h4 th:text="#{footer.terms.title}">使用条款</h4>
                <ul>
                    <li th:text="#{footer.terms.1}">禁止缩短包含恶意软件、病毒或其他有害内容的链接</li>
                    <li th:text="#{footer.terms.2}">禁止用于垃圾邮件、钓鱼或其他欺诈活动</li>
                    <li th:text="#{footer.terms.3}">我们保留删除违规链接的权利</li>
                    <li th:text="#{footer.terms.4}">服务可能因维护或其他原因暂时中断</li>
                </ul>
            </div>
        </div>

        <!-- 版权信息 -->
        <div class="copyright">
            <div class="copyright-main">
                <p th:text="#{footer.copyright}">&copy; 2025 Mini URI. 保留所有权利。</p>
            </div>
            <div class="links">
                <a href="#" onclick="showPrivacyPolicy()" th:text="#{footer.link.privacy}">隐私政策</a>
                <span class="separator">|</span>
                <a href="#" onclick="showServiceTerms()" th:text="#{footer.link.terms}">服务条款</a>
                <span class="separator">|</span>
                <a href="#" onclick="showContact()" th:text="#{footer.link.contact}">联系我们</a>
            </div>
        </div>
    </div>
</footer>

<script th:inline="javascript">
    // 国际化文本
    const i18n = {
        buttonGenerate: /*[[#{button.generate}]]*/ '生成短链接',
        buttonGenerating: /*[[#{button.generating}]]*/ '生成中...',
        buttonCopy: /*[[#{button.copy}]]*/ 'Copy',
        buttonCopied: /*[[#{button.copied}]]*/ 'Copied!',
        alertInputEmpty: /*[[#{alert.input.empty}]]*/ '请输入原始链接',
        alertGenerateFailed: /*[[#{alert.generate.failed}]]*/ '生成失败',
        alertNoCopyContent: /*[[#{alert.no.copy.content}]]*/ '没有可复制的内容',
        alertCopyFailed: /*[[#{alert.copy.failed}]]*/ '复制失败，请手动复制',
        qrCodeShow: /*[[#{footer.qrcode.show}]]*/ '显示赞赏码',
        qrCodeHide: /*[[#{footer.qrcode.hide}]]*/ '隐藏赞赏码',
        dialogPrivacyTitle: /*[[#{dialog.privacy.title}]]*/ '隐私政策',
        dialogPrivacyContent: /*[[#{dialog.privacy.content}]]*/ '',
        dialogTermsTitle: /*[[#{dialog.terms.title}]]*/ '服务条款',
        dialogTermsContent: /*[[#{dialog.terms.content}]]*/ '',
        dialogContactTitle: /*[[#{dialog.contact.title}]]*/ '联系我们',
        dialogContactContent: /*[[#{dialog.contact.content}]]*/ ''
    };
</script>

<script>
    window.addEventListener('DOMContentLoaded', function () {
        const btnGenerate = document.getElementById('generate');
        const inputLong = document.getElementById('long');
        const inputShort = document.getElementById('short');
        const btnCopy = document.getElementById('copy');
        const btnClearLong = document.getElementById('clear-long');
        const longWrapper = document.getElementById('long-wrapper');

        // 根据是否有值切换 has-value 类，控制 × 的显隐
        const updateHasValue = () => {
            if (inputLong.value && inputLong.value.trim().length > 0) {
                longWrapper.classList.add('has-value');
            } else {
                longWrapper.classList.remove('has-value');
            }
        };
        inputLong.addEventListener('input', updateHasValue);
        inputLong.addEventListener('change', updateHasValue);
        inputLong.addEventListener('focus', updateHasValue);
        inputLong.addEventListener('blur', updateHasValue);
        updateHasValue();

        // 点击 × 清除输入（封装成函数，供多事件复用）
        function clearLongNow(e) {
            if (e) { e.preventDefault(); e.stopPropagation(); }
            inputLong.value = '';
            inputShort.value = '';
            // 触发 input 事件，确保所有监听者（含样式联动）正确响应
            try { inputLong.dispatchEvent(new Event('input', { bubbles: true })); } catch (_){}
            // 下一帧再更新 has-value，避免在当前点击过程中立刻把按钮变成不可点导致“清不掉”
            setTimeout(updateHasValue, 0);
            inputLong.focus({ preventScroll: true });
        }

        // 防止按下时切换焦点，避免触发父级状态变化
        btnClearLong.addEventListener('mousedown', function (e) { e.preventDefault(); });
        btnClearLong.addEventListener('touchstart', function (e) { clearLongNow(e); }, { passive: false });
        btnClearLong.addEventListener('click', function (e) { clearLongNow(e); });

        // 防抖处理和按钮状态管理
        let isGenerating = false;
        const originalButtonText = btnGenerate.textContent;

        function setButtonLoading(loading) {
            if (loading) {
                btnGenerate.disabled = true;
                btnGenerate.textContent = i18n.buttonGenerating;
                isGenerating = true;
            } else {
                btnGenerate.disabled = false;
                btnGenerate.textContent = originalButtonText;
                isGenerating = false;
            }
        }

        btnGenerate.addEventListener('click', function () {
            // 防止重复点击
            if (isGenerating) {
                return;
            }

            const originalUrl = inputLong.value.trim();
            const checked = document.querySelector('input[name="expirationTime"]:checked');
            const expireTime = checked ? checked.value : '1';

            if (!originalUrl) {
                alert(i18n.alertInputEmpty);
                return;
            }

            // 设置按钮为加载状态
            setButtonLoading(true);

            generateUri({
                originalUrl: originalUrl,
                expireTime: expireTime
            }).then(function (res) {
                if (res && res.code === 200) {
                    inputShort.value = res.data || '';
                } else {
                    alert(res && (res.msg || res.message) || i18n.alertGenerateFailed);
                }
            }).catch(function (err) {
                alert(err && err.message ? err.message : String(err));
            }).finally(function () {
                // 无论成功还是失败，都要恢复按钮状态
                setButtonLoading(false);
            });
        });

        btnCopy.addEventListener('click', function () {
            const text = inputShort.value || '';
            if (!text) {
                alert(i18n.alertNoCopyContent);
                return;
            }
            if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
                navigator.clipboard.writeText(text).then(function () {
                    btnCopy.textContent = i18n.buttonCopied;
                    setTimeout(function () { btnCopy.textContent = i18n.buttonCopy; }, 2000);
                }).catch(function () {
                    fallbackCopy();
                });
            } else {
                fallbackCopy();
            }
        });

        function fallbackCopy() {
            inputShort.select();
            try {
                const ok = document.execCommand('copy');
                if (ok) {
                    btnCopy.textContent = i18n.buttonCopied;
                    setTimeout(function () { btnCopy.textContent = i18n.buttonCopy; }, 2000);
                } else {
                    alert(i18n.alertCopyFailed);
                }
            } catch (e) {
                alert(i18n.alertCopyFailed);
            } finally {
                window.getSelection && window.getSelection().removeAllRanges();
                inputShort.blur();
            }
        }
    });

    // 懒加载功能
    let qrImageLoaded = false;

    function loadQRImage() {
        if (qrImageLoaded) return;

        const qrImage = document.getElementById('qr-image');
        const qrPlaceholder = document.getElementById('qr-placeholder');
        const qrLoading = document.getElementById('qr-loading');
        const dataSrc = qrImage.getAttribute('data-src');

        if (!dataSrc) {
            console.error('图片 data-src 未设置');
            return;
        }

        // 显示加载状态
        qrLoading.style.display = 'flex';

        qrImage.onload = function() {
            // 图片加载完成
            qrImageLoaded = true;
            qrPlaceholder.style.opacity = '0';
            qrLoading.style.display = 'none';
            qrImage.style.display = 'block';
            qrImage.classList.add('loaded');
        };

        qrImage.onerror = function() {
            // 图片加载失败，隐藏加载状态，保持占位符
            qrLoading.style.display = 'none';
            console.warn('赞赏码图片加载失败');
        };

        // 开始加载图片
        qrImage.src = dataSrc;
    }

    // 页脚功能函数
    window.toggleQRCode = function() {
        const qrCode = document.getElementById('qr-code');
        const button = document.querySelector('.btn-show-qr');

        if (qrCode.style.display === 'none' || qrCode.style.display === '') {
            qrCode.style.display = 'block';
            button.textContent = i18n.qrCodeHide;

            // 当显示赞赏码时，直接加载图片
            loadQRImage();
        } else {
            qrCode.style.display = 'none';
            button.textContent = i18n.qrCodeShow;
        }
    };

    window.showPrivacyPolicy = function() {
        alert(i18n.dialogPrivacyContent);
    };

    window.showServiceTerms = function() {
        alert(i18n.dialogTermsContent);
    };

    window.showContact = function() {
        alert(i18n.dialogContactContent);
    };

    // 初始化页脚
    document.addEventListener('DOMContentLoaded', function() {
        // 隐藏赞赏码
        const qrCode = document.getElementById('qr-code');
        if (qrCode) {
            qrCode.style.display = 'none';
        }
    });
</script>
</body>
</html>

